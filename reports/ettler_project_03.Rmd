---
title: "Adverse effect of bexaroten therapy in T-lymphom "
author: "Jiri Baloun"
date: "Compiled on: **2025-04-25**  <br> Last updated **`r format(Sys.time(), '%Y-%m-%d')`**"
output:
  html_document:
    code_folding: hide
    df_print: paged
    theme: yeti
    highlight: tango
    toc: yes
    toc_float:
      collapsed: true
      smooth_scroll: true
    number_sections: true
  pdf_document:
    fig_caption: yes
    toc: yes
editor_options: 
  markdown: 
    wrap: 72
---

```{=html}
<style type="text/css">
.title {
  text-align: center;
}
.author {
  font-size: 30px;
  text-align: center;
  font-style: italic;
  font-weight: 300;
}
.date {
  font-weight: 300;
}
h1, h2, h3, h4, h5 {
    font-weight: 600;
    margin-top: 2em;
}
body {text-align: justify}
blockquote {
    padding: 10px 20px;
    margin: 0 0 20px;
    font-size: 14px;
    border-left: 5px solid #eee;
}
p {
  text-indent: 2rem;
}
table {
    width:100%;
}
.main-container {
  max-width: 100% !important;
  margin: auto;
}
img{
    height: 100%;
    width: 100%;
    object-fit: cover;
}
.boxBorder {
     border: 2px solid #990066;
     padding: 10px;
     outline: #990066 solid 5px;
     outline-offset: 5px;
   }
</style>
```
```{r setup, fig.align = 'center', include=FALSE}
knitr::opts_chunk$set(
    echo = TRUE,
    message = FALSE,
    warning = FALSE,
    knitr.kable.NA = ''  # if it does not work, use this  options(knitr.kable.NA = '')
)
options(knitr.kable.NA = '')

# Functions
## loading  
pacman::p_load(update = FALSE,
               tidyverse, purrr, furrr, easystats, rio, janitor, ggthemes, car,
               gtsummary, skimr, sjPlot, flextable, ggpubr, rstatix, tidymodels,
               psych, paletteer, ComplexHeatmap, future, multidplyr, corrr, 
               factoextra, lmerTest, ggforce, lazyWeave, FactoMineR, sjPlot,
               kableExtra, survival, survminer, ggsurvfit, ggfortify, 
               adjustedCurves, ggbeeswarm
  ) 
## function specification ----
conflicted::conflicts_prefer(
  janitor::remove_empty,
  dplyr::filter,
  dplyr::mutate,
  dplyr::rename,
  dplyr::summarize,
  dplyr::summarise,
  dplyr::select,
  purrr::map,
  tidyr::extract,
  stats::chisq.test,
  base::intersect,
  base::setdiff,
  dplyr::last,
  dplyr::first, 
  dplyr::between,
  corrr::correlate,
  purrr::set_names,
  dplyr::desc,
  rstatix::chisq_test,
  stats::fisher.test,
  kableExtra::footnote
)

## Manual 
# skimr
my_skim <- skimr::skim_with(numeric = sfl(median = ~ median(., na.rm = TRUE),
                                          mad = ~ mad(., na.rm = TRUE)), 
                            append = TRUE)

# Load objects
load("markD_03.RData")

# Load cores
no_cores <- parallelly::availableCores() -1

# Load functions
list.files("F:/Analysis/github/project-ettler01/scripts/functions/", pattern="*.*", full.names=TRUE) %>% str_subset( "OBJ", negate = TRUE) %>%  map(~source(.))

# Parameter selection ----
param_sel <- c("initials", "age", "sex", "bmi", "ae_grade_3_4",
               "ae_hyperTAG_grade_3_4","discontinued_due_to_ae", "ae_liver",
               "ae_hemato", "ps_ecog", "stage_early", "first_syst_th",
               "thyroid_disease_before", "monotherapy", "response_achieved",
               "dyslipidemia_before")

param_sel_2 <- c("initials", "age", "sex", "bmi", "ps_ecog", "stage_early",
                 "first_syst_th", "response_achieved", "thyroid_disease_before",
                 "dyslipidemia_before", "monotherapy", "ttnt", "ttnt_achieved",
                 "response_time_to", "response_duration",	"progression",
                 "treatment_duration", "discontinuation_reason", "ae_grade_3_4",
                 "ae_liver", "ae_hemato", "discontinued_due_to_ae",
                 "ae_hyperTAG_grade_3_4", "ae_hyperTAG_any"
                 
)

variab_dep_01 <- c("discontinued_due_to_ae", "ae_hyperTAG_any", 
                    "ae_hyperTAG_grade_3_4", "ae_liver",	"ae_hemato")
variab_indep_01 <- c("age", "sex", "bmi", "ps_ecog", "stage_early", "first_syst_th",
                     "response_achieved", "dyslipidemia_before", 
                     "thyroid_disease_before", "monotherapy"  
)

variab_dep_02a <- c("response_achieved" 
)
variab_dep_02b <- c("treatment_duration", "discontinuation_reason",
                    "ttnt", "ttnt_achieved"
)
variab_dep_02c <- c("response_time_to",                 # only non-zero patients
                    "response_duration", "progression")
variab_indep_02 <- c("age", "sex", "bmi", "ps_ecog", "first_syst_th", "ae_grade_3_4",
                     "monotherapy")
# Object processing  

```


# Questions  
- [x]  In column $response_achieved$ there is value $x$. What does it mean?  
- [x]  The same is in the column $discontinued_due_to_ae$. What does the $x$ mean?  
- [x]  I removed all $lost of FU$.  
- [x]  Should I use $ae\_hyperTA\_G_any$ (column AP) instead of $ae\_complete\_grade\_3\_4$ (column AN) in question I.A.2.? In the $ae\_hyperTAG\_any$ (column AP), there is the selection of any *hyperTAG* in adverse effect.  


# Notes  
* The variable $ae\_hyperTAG\_any$ is perfectly predicted by $thyroid\_disease\_before$. In other words, the logistic regression model fits this pair of variables too perfectly — producing predicted probabilities of 0 or 1 with no uncertainty.

# Abbrativations

| Parameter                          | Description                                                                                           | Column Name               |
|------------------------------------|-------------------------------------------------------------------------------------------------------|---------------------------|
| Initials                           | XX = surname, forename                                                                                | initials                  |
| Center                             | CZ/DE                                                                                                 | center                    |
| Age                                | at the time of initiation of Bexaroten (years)                                                       | age                       |
| Sex                                | M/F                                                                                                   | sex                       |
| BMI                                | at the time of initiation of Bexarotene                                                               | bmi                       |
| PS ECOG                            | at the time of initiation of Bexarotene                                                               | ps_ecog                   |
| CTCL type                          | according to WHO-EORTC 2018                                                                           | ctcl_type                 |
| Stage                              | at the time of initiation of Bexarotene                                                               | stage                     |
| Early Stage?                       | 1= yes   0= no                                                                                         | stage_early               |
| T                                  | at the time of initiation of Bexarotene                                                               | t_stage                   |
| N                                  | at the time of initiation of Bexarotene                                                               | n_stage                   |
| M                                  | at the time of initiation of Bexarotene                                                               | m_stage                   |
| B                                  | at the time of initiation of Bexarotene                                                               | b_stage                   |
| Time since Dg.                     | at the time of initiation of Bexarotene (months)                                                      | months_since_diagnosis    |
| Time since 1. clin. manifestation  | Before the initiation of Bexarotene (months)                                                          | months_since_first_symptom|
| Radiologic Examinations           | Dg. Procedures, such as CT, PET, USG.. Any time during the course of disease (0=only clin. Exam.)     | radiologic_exams          |
| SDT before                         | Skin directed therapy preceding the initiation of bexarotene, incl. Radiotherapy                      | sdt_before                |
| SysTh before                       | Systemic treatments preceding the initiation of bexarotene (incl. + TSEI with > 50% BSA) + TSEI >50% BSA | systh_before           |
| First syst, Therapy?               | 1= yes   0= no                                                                                         | first_syst_th             |
| Initial dose                       | Daily Dose (mg/m²)                                                                                    | initial_dose_mg_m2        |
| Final dose                         | The highest tolerable daily dose (mg/m²)                                                              | final_dose_mg_m2          |
| Initial SysTh                      | Other antineoplastic Systemic therapies at the time of initiation of Bexarotene                       | initial_systh             |
| SysTh during the Treatment         | Other antineoplastic Systemic therapies during the treatment with bexarotene (duration in months)     | systh_during_treatment    |
| SDT during the Treatment           | Skin directed Therapy during the treatment with bexarotene                                            | sdt_during_treatment      |
| Best treatment response            | SD, PR, CR                                                                                            | response_best             |
| Response?                          | 1=PR, CR,  0= SD,PD                                                                                   | response_achieved         |
| MonoTh?                            | was the best treatment response achieved during the monotherapy (1=yes, 0=no)                         | monotherapy               |
| Time to Response                   | time to achieve the best treatment response (0=only SD achieved)                                      | response_time_to          |
| Duration of response               | until progression or last visit (months)                                                              | response_duration         |
| Progression?                       | progression during the treatment (1=yes, 0=no)                                                        | progression               |
| Duration of treatment              | (months)                                                                                              | treatment_duration        |
| Reason to discontinuation          | 0=treatment continues                                                                                 | discontinuation_reason    |
| Discontinued because of AE?        | 1=yes, 0=no                                                                                            | discontinued_due_to_ae    |
| TTNT                                | TTNT (x = TTNT not achieved )                                                                         | ttnt                      |
| TTNT achieved?                     | 1=yes, 0=no (no "next treatment" given)                                                               | ttnt_achieved             |
| Comorbidities                      |                                                                                                       | comorbidities             |
| Dyslipidemia before bexaroten?     | 1=yes, 0=no                                                                                            | dyslipidemia_before       |
| Thyroid disease before bexarotene? | 1=yes, 0=no                                                                                            | thyroid_disease_before    |
| Adverse events (treatment)         | (all grades)                                                                                           | ae_complete_all           |
| AE Grade 3 / 4 (event. 5)          |                                                                                                       | ae_complete_grade_3_4     |
| AE Grade 3/4                       | 1=yes, 0=no                                                                                            | ae_grade_3_4              |
| AE hyperTAG any Grade?             | 1=yes, 0=no                                                                                            | ae_hyperTAG_any           |
| AE hyperTAG Grade 3/4?             | 1=yes, 0=no                                                                                            | ae_hyperTAG_grade_3_4     |
| AE Liver Tests elevation (any grade)| 1=yes, 0=no                                                                                           | ae_liver                  |
| Haematologic AE (any grade)        | 1=yes, 0=no                                                                                            | ae_hemato                 |


# Exporatory Data Analyses (EDA) {.tabset .tabset-fade .tabset-pills}  

Exploratory Data Analysis (EDA) involves visualizing and summarizing data to uncover patterns, anomalies, and relationships, assess data quality, and guide feature selection. By identifying outliers, missing values, and distributions, EDA informs model choice, suggests transformations, and refines hypotheses, ensuring more reliable and insightful downstream analysis.

## Overview {.unnumbered}  

In the table below, a basic overview of the analyzed data is presented. Seven variables contain one missing value each. Additionally, $discontinued_due_to_ae$ and $response_duration$ contain 12 and two missing values, respectively. 


```{r eda_skimr, results="asis"}
d04 |> 
  select(-initials) |>  
  mutate(across(
    .cols = -c(bmi, age), 
    .fns = as.factor
  )) |> 
  my_skim()

```


## Proportional Bar plot {.unnumbered}

A proportional bar plot illustrates the relative size of each category by showing values as proportions. The figure below reveals notable imbalances across most variables. In several cases, such as $ae\_hyperTAG\_any$, $ae\_hemato$, and $thyroid\_disease\_before$, a strong disproportion is evident. Such imbalance can compromise statistical analyses by violating assumptions like equal variance or sample size, thereby reducing the ability to detect patterns in smaller subgroups.

```{r eda_barplot}
d04 |> 
  select(-initials, -age, -bmi, -contains("duration"), -ttnt,
         -contains("time_to")) |> 
  select(where(is.numeric)) |> 
  mutate(across(everything(),as.factor)) |> 
  pivot_longer(cols = everything()) |> 
  na.omit() |> 
  ggplot(aes(x = name, fill = as.factor(value))) +
  geom_bar(position = "fill") +  # Proportions
  labs(y = "Proportion", fill = "Outcome") +
  theme_sjplot2()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  paletteer::scale_fill_paletteer_d("waRhol::marilyn_orange_62") +
  NULL
```


# Statistics  
## BMI & hypertriglyceridemia  {.tabset .tabset-fade .tabset-pills}   
### Box Plot - BMI {.unnumbered}  

This figure illustrates the distribution of Body Mass Index (BMI) among patients categorized by the presence or absence of Grade 3–4 Hypertriglyceridemia. The x-axis represents two groups: 0 for patients without Grade 3–4 hypertriglyceridemia (red dots) and 1 for those with it (blue dots). Each dot corresponds to an individual patient's BMI value.  
Central tendency and variability within each group are summarized using horizontal black bars, which indicate the median and the Median Absolute Deviation (MAD) intervals. This method provides a robust estimate of spread, especially useful in datasets that may contain outliers or are not normally distributed.  
A Wilcoxon rank-sum test was used to assess the statistical significance of the difference in BMI between the two groups. The resulting p-value of 0.0069 suggests a statistically significant difference in BMI distribution between patients with and without Grade 3–4 hypertriglyceridemia.  
Overall, the figure indicates that BMI is significantly associated with the occurrence of severe hypertriglyceridemia. Patients in the hypertriglyceridemia group (Group 1) tend to show greater variability in BMI and possibly higher values, which may contribute to the observed statistical difference.  

```{r eda_boxplot_bmi}
d04 |> 
  ggplot(aes(x = factor(ae_hyperTAG_grade_3_4), 
             y = bmi, 
             color = factor(ae_hyperTAG_grade_3_4))) +
  geom_beeswarm(cex = 3.5, size = 3.5) +
  scale_color_brewer(
    palette = "Set1", 
    name = "Grade 3–4 Hypertriglyceridemia"
  ) +
  stat_summary(fun.data = ggpubr::median_mad, 
               geom = "errorbar", 
               color = "black", 
               width = 0.2, 
               size = 1) +
  stat_summary(fun = median, 
               geom = "crossbar", 
               color = "black", 
               size = 0.8, 
               width = 0.3) +
  labs(
    y = "Body Mass Index (BMI)",
    title = "Grade 3–4 Hypertriglyceridemia",
    caption = "The error bars represent Median Absolute Deviations (MAD) intervals with the median."
  ) +
  theme_minimal(base_size = 13) +
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.title.y = element_text(face = "bold", size = 18),
    axis.text = element_text(size = 14, face = "bold"),
    plot.title = element_text(hjust = 0.5, size = 20, face = "bold")
  ) + stat_compare_means(paired = F)
```

### Fisher Exact test {.unnumbered}  
To assess the association between elevated BMI and the presence of Grade 3–4 hypertriglyceridemia, we performed Fisher’s exact tests using two binary BMI thresholds: 25 (overweight) and 30 (obesity). Patients were classified into two groups based on whether their BMI was below or above each threshold. The association was then evaluated using 2×2 contingency tables and the Fisher’s exact test, which is appropriate for small sample sizes and categorical data.

Results
The analysis at a BMI threshold of 25 revealed an odds ratio (OR) of 2.736 (95% CI: 0.671–12.712) with a p-value of 0.134, indicating a non-significant association. In contrast, the threshold of BMI = 30 yielded a statistically significant result, with an odds ratio of 7.558 (95% CI: 1.189–86.175) and a p-value of 0.019. This suggests that individuals with a BMI ≥ 30 are significantly more likely to develop Grade 3–4 hypertriglyceridemia compared to those with lower BMI.



```{r stat_fisher}
res_fisher_01 <- d04 |> 
  select(ae_hyperTAG_grade_3_4, bmi) |> 
  mutate(
    bmi = if_else(bmi < 25, 0, 1)
  ) |> 
  table() |> 
  fisher.test() |> 
  tidy() |> 
  mutate(Treshold = "BMI = 25") |> 
  relocate( method, Treshold) |> 
  bind_rows(
    d04 |> 
      select(ae_hyperTAG_grade_3_4, bmi) |> 
      mutate(
        bmi = if_else(bmi < 30, 0, 1)
      ) |> 
      table() |> 
      fisher.test() |> 
      tidy() |> 
      mutate(Treshold = "BMI = 30") |> 
      relocate(Treshold)
  )

res_fisher_01 |> 
  select(-alternative) |> 
  kable(col.names = c("Method", "Threshold", "Odds Ratio", "p-value",
                      "5% CI", "95% CI"),
        digits = 3) |> 
  kable_styling(
    full_width = F,
    latex_options = c(
      "hold_position" # stop table floating
    ),
    bootstrap_options = c("striped", "hover", "condensed", "responsive")
  ) %>%
  collapse_rows(columns = 1, valign = "top")
```

## Multiple correspondence analyses  

Multiple Correspondence Analysis (MCA) is a dimensionality reduction technique for categorical data. It helps identify associations among variable categories and visualizes underlying structures by projecting data into a low-dimensional space. In the first figure, the ten most influential variables are shown, with closer items indicating stronger co-occurrence.

The second figure groups individuals based on variables such as $sex$ and $ae\_grade\_3\_4$, and overlays concentration ellipses. These ellipses highlight the degree of overlap and separation between groups. For example, a clear separation is observed for $ae\_grade\_3\_4$, while $sex$ does not show such distinction.

```{r stat_mca, out.width="50%"}
res_mca_02 <- d04 |> select(-initials, -age, -bmi) |> na.omit() |> 
  mutate(across(everything(),as.factor)) |> 
  MCA(graph = FALSE)
fviz_mca_var(res_mca_02, 
             select.var = list(contrib = 10),  # only top ten variables
             repel = TRUE, ggtheme = theme_minimal(),
             col.var = "contrib",
             # choice = "mca.cor",
             gradient.cols = c("#bdbdbd", "#ffeda0", "#FC4E07"))

fviz_ellipses(res_mca_02, c("sex", "ae_grade_3_4"),
              geom = "point")
```


## I. section  
### Logistic model  

The logistic regression analyses explored associations between selected independent variables and adverse outcomes related to treatment tolerability.  

- **Monotherapy** was significantly associated with treatment discontinuation due to adverse events (`discontinued_due_to_ae`), with an odds ratio (OR) of 5.33 and a p-value of 0.043.  
- **BMI** was significantly associated with the occurrence of **Grade 3–4 hypertriglyceridemia** (`ae_hyperTAG_grade_3_4`), showing an OR of 1.23 and a p-value of 0.01.  

No other associations reached statistical significance at the 0.05 threshold. These findings suggest that BMI and treatment regimen may be key factors in predicting specific toxicity outcomes.  

<u>**The model equation:**</u>
$$
\begin{aligned}
\operatorname{Dependent variable} &\sim Bernoulli\left(\operatorname{prob}_{\operatorname{Dependent variable} = \operatorname{1}}= \hat{P}\right) \\
 \log\left[ \frac { \hat{P} }{ 1 - \hat{P} } \right] 
 &= \alpha + \beta_{1}(\operatorname{Independent variable})
\end{aligned}
$$


```{r stat_1_logistic}
res_logist_02 <- d04 |> 
  select(all_of(c(variab_indep_01, variab_dep_01))) |> 
  mutate(sex = if_else(sex == "M", 1, 0)) |> 
  pivot_longer(
    cols = all_of(variab_dep_01),
    names_to = "dep_name",
    values_to = "dep_value"
  ) |> 
  pivot_longer(cols = all_of(variab_indep_01),
               names_to = "indep_name",
               values_to = "indep_value") |> 
  group_by(dep_name,indep_name) |> 
  nest() |> 
  mutate(mod = map(data, ~glm(dep_value ~ indep_value, 
                              data = .x, family = "binomial")),
         tidier = map(mod, ~tidy(.x, conf.int = T, exp = T)))

res_logist_02_tab <- res_logist_02 |> 
  unnest(tidier) |> 
  filter(term == "indep_value") |> 
  select(-data, -mod, -term) |> 
  mutate(across(where(is.numeric), ~round(.x,3)))

res_logist_02_tab |> 
  select(-std.error, - statistic) |> 
  kable(col.names = c("Dependent", "Independent", "Odds Ratio", "p-value",
                      "5% CI", "95% CI")) |> 
  kable_styling(
    full_width = F,
    latex_options = c(
      "hold_position" # stop table floating
    ),
    bootstrap_options = c("striped", "hover", "condensed", "responsive")
  ) %>%
  collapse_rows(columns = 1, valign = "top")
```


## II. section  

In the second part, we focused on evaluation of efficacy and its influencing factors.

### Logistic regression {.tabset .tabset-fade .tabset-pills}  


#### Without *Stage Early* definition {.unnumbered}  

In the table below, we see that $response\_achieved$ was not affected by any selected independent variable.

<u>**The model equation:**</u>
$$
\begin{aligned}
\operatorname{Dependent variable} &\sim Bernoulli\left(\operatorname{prob}_{\operatorname{Dependent variable} = \operatorname{1}}= \hat{P}\right) \\
 \log\left[ \frac { \hat{P} }{ 1 - \hat{P} } \right] 
 &= \alpha + \beta_{1}(\operatorname{Independent variable})
\end{aligned}
$$

```{r stat_2_logistic}
res_logist_03 <- d04 |> 
  select(all_of(c(variab_indep_02, variab_dep_02a))) |> 
  mutate(sex = if_else(sex == "M", 1, 0)) |> 
  pivot_longer(
    cols = all_of(variab_dep_02a),
    names_to = "dep_name",
    values_to = "dep_value"
  ) |> 
  pivot_longer(cols = all_of(variab_indep_02),
               names_to = "indep_name",
               values_to = "indep_value") |> 
  group_by(dep_name,indep_name) |> 
  nest() |> 
  mutate(mod = map(data, ~glm(dep_value ~ indep_value, 
                              data = .x, family = "binomial")),
         tidier = map(mod, ~tidy(.x, conf.int = T, exp = T)))

res_logist_03_tab <- res_logist_03 |> 
  unnest(tidier) |> 
  filter(term == "indep_value") |> 
  select(-data, -mod, -term) |> 
  mutate(across(where(is.numeric), ~round(.x,3)))

res_logist_03_tab |> 
  select(-std.error, - statistic) |> 
  kable(col.names = c("Dependent", "Independent", "Odds Ratio", "p-value",
                      "5% CI", "95% CI")) |> 
  kable_styling(
    full_width = F,
    latex_options = c(
      "hold_position" # stop table floating
    ),
    bootstrap_options = c("striped", "hover", "condensed", "responsive")
  ) %>%
  collapse_rows(columns = 1, valign = "top")
```



#### With *Stage Early* definition {.unnumbered}  

In the table below, we see that $response\_achieved$ was not affected by any selected independent variable ever after the adjustation for $stage\_early$.  
I also tried the interaction between $response\_achieved$ and $stage\_early$ without success.

<u>**The model equation:**</u>
$$
\begin{aligned}
\operatorname{Dependent variable} &\sim Bernoulli\left(\operatorname{prob}_{\operatorname{Dependent variable} = \operatorname{1}}= \hat{P}\right) \\
 \log\left[ \frac { \hat{P} }{ 1 - \hat{P} } \right] 
 &= \alpha + \beta_{1}(\operatorname{Independent variable}) + \beta_{2}(\operatorname{Stage Early})
\end{aligned}
$$

```{r stat_2_logistic_stageEarly}
res_logist_04 <- d04 |> 
  select(stage_early, all_of(c(variab_indep_02, variab_dep_02a))) |> 
  mutate(sex = if_else(sex == "M", 1, 0)) |> 
  pivot_longer(
    cols = all_of(variab_dep_02a),
    names_to = "dep_name",
    values_to = "dep_value"
  ) |> 
  pivot_longer(cols = all_of(variab_indep_02),
               names_to = "indep_name",
               values_to = "indep_value") |> 
  group_by(dep_name,indep_name) |> 
  nest() |> 
  mutate(mod = map(data, ~glm(dep_value ~ indep_value + stage_early, 
                              data = .x, family = "binomial")),
         tidier = map(mod, ~tidy(.x, conf.int = T, exp = T)),
         mod2 = map(data, ~glm(dep_value ~ indep_value * stage_early, 
                              data = .x, family = "binomial")),
         tidier2 = map(mod2, ~tidy(.x, conf.int = T, exp = T))
         )

res_logist_04_tab_a <- res_logist_04 |> 
  unnest(tidier) |> 
  filter(!str_detect(term, "Intercept")) |> 
  select(-data, -mod, -mod2, -tidier2) |> 
  mutate(across(where(is.numeric), ~round(.x,3)))

res_logist_04_tab_a |> 
  select(-std.error, - statistic) |> 
  kable(col.names = c("Dependent", "Adjusted for", "Independent", "Odds Ratio", "p-value",
                      "5% CI", "95% CI")) |> 
  kable_styling(
    full_width = F,
    latex_options = c(
      "hold_position" # stop table floating
    ),
    bootstrap_options = c("striped", "hover", "condensed", "responsive")
  ) %>%
  collapse_rows(columns = 1:2, valign = "top")
```




### Survival analyses {.tabset .tabset-fade .tabset-pills}  

A Kaplan–Meier analysis estimates the probability of an event (e.g., death, relapse) over time in a cohort, properly accounting for censored observations (subjects lost to follow-up or event-free at last contact). The result is a stepwise survival curve that drops at each event time, providing a clear visualization of time-to-event data.  

A Cox proportional hazards (PH) model assesses the effect of one or more covariates on the hazard (instantaneous event rate) over time, without requiring specification of the baseline hazard function. It yields hazard ratios (HRs) that represent the relative risk associated with covariates, assuming the hazard functions are proportional between groups.


#### Time to next treatment  {.tabset .unnumbered}  

##### Kaplan-Meier Overall  {.unnumbered}  

A single Kaplan–Meier curve summarizes the entire cohort’s survival experience:  
- **Median survival time:** The point at which the estimated survival probability falls to 50%.  
- **Fixed-time survival rates:** Survival probabilities at landmarks such as 1 year or 5 years.  
- **Numbers at risk/censoring:** Often displayed below the curve to show how many subjects remain under observation at each interval.


```{r stat_2_surv_ttnt_overall}
res_surv_ttnt_02$surv[[1]]$`KM overall`
```


##### Kaplan-Meier Stratified  {.tabset .unnumbered}  

When you divide the cohort into subgroups (e.g., treatment vs. control, biomarker high vs. low), you generate separate curves to compare survival patterns:  
- **Overlaid curves:** Different line styles or colors distinguish each subgroup.  
- **Dashed line at 50% survival:** Marks the median survival time across curves for visual comparison.  
- **Log-rank test p-value:** Assesses whether observed differences between curves are statistically significant.  
- **Hazard ratio (optional):** From a Cox model, quantifies the relative risk between strata.  
- **Group-specific medians and landmark rates:** Reported side-by-side to highlight subgroup differences.  
- **P-values:** P-values indicate the overall effect of the variable on the dependent variable without sub-setting

###### PS-ECOG {.unnumbered}  
```{r stat_2_surv_ttnt_stratified_ecog}
res_surv_ttnt_02$surv[[1]]$`KM stratified`
```

###### First Systemic Therapy {.unnumbered}  
```{r stat_2_surv_ttnt_stratified_firstSYSther}
res_surv_ttnt_02$surv[[2]]$`KM stratified`
```

###### AE Grade 3-4 {.unnumbered}  
```{r stat_2_surv_ttnt_stratified_aeGRADE34}
res_surv_ttnt_02$surv[[3]]$`KM stratified`
```

###### Monotherapy {.unnumbered}  
```{r stat_2_surv_ttnt_stratified_monotherapy}
res_surv_ttnt_02$surv[[4]]$`KM stratified`
```

###### Gender {.unnumbered}  
```{r stat_2_surv_ttnt_stratified_sex}
res_surv_ttnt_02$surv[[5]]$`KM stratified`
```

##### Cox Proportional Hazards {.tabset .unnumbered}  

***Cox PH Table Output***

A standard Cox PH results table typically includes:  
- **Hazard Ratio (HR):** The estimated relative risk per unit change (or category) in each covariate.  
- **95% Confidence Interval (CI):** Lower and upper bounds for the HR, indicating precision.  
- **p-value:** Significance of the association between each covariate and the hazard.

***Cox PH Plot***

To visualize model-based survival differences you can use:  
- **Dichotomous variable plot:** Two survival curves (e.g., exposed vs. unexposed), annotated with HR and p-value from the Cox model.  


**Forest Plot Analysis**  

This forest plot displays the effect estimates from a Cox proportional hazards model:  

- **Point estimates and confidence intervals (CIs):** Each covariate is represented by a square indicating the hazard ratio (HR), with horizontal lines showing the 95% confidence interval.   
- **Reference categories:** For categorical variables (e.g., `stage_early`), one level is set as the reference.  
- **Continuous variable (`var_indep`):** Modeled directly without categorization, showing the HR per unit increase.  
- **Global model metrics:** The bottom of the plot displays the number of events, global p-value from the log-rank test, AIC, and concordance index, reflecting model fit and discrimination.  

This approach allows for a more precise estimation of the continuous variable’s effect without loss of information due to categorization.  


###### PS-ECOG {.unnumbered}  
```{r stat_2_surv_cox_table_ecog}
res_surv_ttnt_02$surv[[1]]$`CoxPH print table`
```

```{r stat_2_surv_cox_plot_ecog}
res_surv_ttnt_02$surv[[1]]$`CoxPH plot`
```


###### First Systemic Therapy {.unnumbered}  
```{r stat_2_surv_cox_table_firstTH}
res_surv_ttnt_02$surv[[2]]$`CoxPH print table`
```

```{r stat_2_surv_cox_plot_firstTH}
res_surv_ttnt_02$surv[[2]]$`CoxPH plot`
```


###### AE Grade 3-4 {.unnumbered}  
```{r stat_2_surv_cox_table_aeGrade}
res_surv_ttnt_02$surv[[3]]$`CoxPH print table`
```

```{r stat_2_surv_cox_plot_aeGrade}
res_surv_ttnt_02$surv[[3]]$`CoxPH plot`
```


###### Monotherapy {.unnumbered}  
```{r stat_2_surv_cox_table_monotherapy}
res_surv_ttnt_02$surv[[4]]$`CoxPH print table`
```

```{r stat_2_surv_cox_plot_monotherapy}
res_surv_ttnt_02$surv[[4]]$`CoxPH plot`
```


###### Gender {.unnumbered}  
```{r stat_2_surv_ttnt_cox_table_gender}
res_surv_ttnt_02$surv[[5]]$`CoxPH print table`
```

```{r stat_2_surv_ttnt_cox_plot_gender}
res_surv_ttnt_02$surv[[5]]$`CoxPH plot`
```


###### BMI {.unnumbered}  
```{r stat_2_surv_cox_table_bmi}
res_surv_ttnt_02$surv[[6]]$`CoxPH print table`
```

```{r stat_2_surv_cox_plot_bmi}
res_surv_ttnt_02$surv[[6]]$`CoxPH plot full`
```

```{r stat_2_surv_cox_forest_bmi}
res_surv_ttnt_02$surv[[6]]$`CoxPH forest plot full`
```


###### Age {.unnumbered}  
```{r stat_2_surv_cox_table_age}
res_surv_ttnt_02$surv[[7]]$`CoxPH print table`
```

```{r stat_2_surv_cox_plot_age}
res_surv_ttnt_02$surv[[7]]$`CoxPH plot full`
```

```{r stat_2_surv_cox_forest_age}
res_surv_ttnt_02$surv[[7]]$`CoxPH forest plot full`
```



#### Duration treatment  {.tabset .unnumbered}  

##### Kaplan-Meier Overall  {.unnumbered}  

A single Kaplan–Meier curve summarizes the entire cohort’s survival experience:  
- **Median survival time:** The point at which the estimated survival probability falls to 50%.  
- **Fixed-time survival rates:** Survival probabilities at landmarks such as 1 year or 5 years.  
- **Numbers at risk/censoring:** Often displayed below the curve to show how many subjects remain under observation at each interval.  


```{r stat_2_surv_durTRTeffect_overall}
res_surv_durTRTeffect_02$surv[[1]]$`KM overall`
```


##### Kaplan-Meier Stratified  {.tabset .unnumbered}  

When you divide the cohort into subgroups (e.g., treatment vs. control, biomarker high vs. low), you generate separate curves to compare survival patterns:  
- **Overlaid curves:** Different line styles or colors distinguish each subgroup.  
- **Dashed line at 50% survival:** Marks the median survival time across curves for visual comparison.  
- **Log-rank test p-value:** Assesses whether observed differences between curves are statistically significant.  
- **Hazard ratio (optional):** From a Cox model, quantifies the relative risk between strata.  
- **Group-specific medians and landmark rates:** Reported side-by-side to highlight subgroup differences.  

###### PS-ECOG {.unnumbered}  
```{r stat_2_surv_durTRTeffect_stratified_ecog}
res_surv_durTRTeffect_02$surv[[1]]$`KM stratified`
```

###### First Systemic Therapy {.unnumbered}  
```{r stat_2_surv_durTRTeffect_stratified_firstSYSther}
res_surv_durTRTeffect_02$surv[[2]]$`KM stratified`
```

###### AE Grade 3-4 {.unnumbered}  
```{r stat_2_surv_durTRTeffect_stratified_aeGRADE34}
res_surv_durTRTeffect_02$surv[[3]]$`KM stratified`
```

###### Monotherapy {.unnumbered}  
```{r stat_2_surv_durTRTeffect_stratified_monotherapy}
res_surv_durTRTeffect_02$surv[[4]]$`KM stratified`
```

###### Gender {.unnumbered}  
```{r stat_2_surv_durTRTeffect_stratified_sex}
res_surv_durTRTeffect_02$surv[[5]]$`KM stratified`
```


##### Cox Proportional Hazards {.tabset .unnumbered}  

***Cox PH Table Output***

A standard Cox PH results table typically includes:  
- **Hazard Ratio (HR):** The estimated relative risk per unit change (or category) in each covariate.    
- **95% Confidence Interval (CI):** Lower and upper bounds for the HR, indicating precision.  
- **p-value:** Significance of the association between each covariate and the hazard.  

***Cox PH Plot***

To visualize model-based survival differences you can use:  
- **Dichotomous variable plot:** Two survival curves (e.g., exposed vs. unexposed), annotated with HR and p-value from the Cox model.  

**Forest Plot Analysis**  

This forest plot displays the effect estimates from a Cox proportional hazards model:  

- **Point estimates and confidence intervals (CIs):** Each covariate is represented by a square indicating the hazard ratio (HR), with horizontal lines showing the 95% confidence interval.   
- **Reference categories:** For categorical variables (e.g., `stage_early`), one level is set as the reference.  
- **Continuous variable (`var_indep`):** Modeled directly without categorization, showing the HR per unit increase.  
- **Global model metrics:** The bottom of the plot displays the number of events, global p-value from the log-rank test, AIC, and concordance index, reflecting model fit and discrimination.  

This approach allows for a more precise estimation of the continuous variable’s effect without loss of information due to categorization.  


###### PS-ECOG {.unnumbered}  
```{r stat_2_surv_durTRTeffect_cox_table_ecog}
res_surv_durTRTeffect_02$surv[[1]]$`CoxPH print table`
```

```{r stat_2_surv_durTRTeffect_cox_plot_ecog}
res_surv_durTRTeffect_02$surv[[1]]$`CoxPH plot`
```


###### First Systemic Therapy {.unnumbered}  
```{r stat_2_surv_durTRTeffect_cox_table_firthTH}
res_surv_durTRTeffect_02$surv[[2]]$`CoxPH print table`
```

```{r stat_2_surv_durTRTeffect_cox_plot_firstTH}
res_surv_durTRTeffect_02$surv[[2]]$`CoxPH plot`
```


###### AE Grade 3-4 {.unnumbered}  
```{r stat_2_surv_durTRTeffect_cox_table_aeGrade}
res_surv_durTRTeffect_02$surv[[3]]$`CoxPH print table`
```

```{r stat_2_surv_durTRTeffect_cox_plot_aeGrade}
res_surv_durTRTeffect_02$surv[[3]]$`CoxPH plot`
```


###### Monotherapy {.unnumbered}  
```{r stat_2_surv_durTRTeffect_cox_table_monotherapy}
res_surv_durTRTeffect_02$surv[[4]]$`CoxPH print table`
```

```{r stat_2_surv_durTRTeffect_cox_plot_monotherapy}
res_surv_durTRTeffect_02$surv[[4]]$`CoxPH plot`
```


###### Gender {.unnumbered}  
```{r stat_2_surv_durTRTeffect_cox_table_gender}
res_surv_durTRTeffect_02$surv[[5]]$`CoxPH print table`
```

```{r stat_2_surv_durTRTeffect_cox_plot_gender}
res_surv_durTRTeffect_02$surv[[5]]$`CoxPH plot`
```


###### BMI {.unnumbered}  
```{r stat_2_surv_durTRTeffect_cox_table_bmi}
res_surv_durTRTeffect_02$surv[[6]]$`CoxPH print table`
```

```{r stat_2_surv_durTRTeffect_cox_plot_bmi}
res_surv_durTRTeffect_02$surv[[6]]$`CoxPH plot full`
```

```{r stat_2_surv_durTRTeffect_cox_forest_bmi}
res_surv_durTRTeffect_02$surv[[6]]$`CoxPH forest plot full`
```


###### Age {.unnumbered}  
```{r stat_2_surv_durTRTeffect_cox_table_age}
res_surv_durTRTeffect_02$surv[[7]]$`CoxPH print table`
```

```{r stat_2_surv_durTRTeffect_cox_plot_age}
res_surv_durTRTeffect_02$surv[[7]]$`CoxPH plot full`
```

```{r stat_2_surv_durTRTeffect_cox_forest_age}
res_surv_durTRTeffect_02$surv[[7]]$`CoxPH forest plot full`
```



#### Disease Progression & Response Time  {.tabset .unnumbered}  
##### Kaplan-Meier Overall  {.unnumbered}  

A single Kaplan–Meier curve summarizes the entire cohort’s survival experience:  
- **Median survival time:** The point at which the estimated survival probability falls to 50%.  
- **Fixed-time survival rates:** Survival probabilities at landmarks such as 1 year or 5 years.  
- **Numbers at risk/censoring:** Often displayed below the curve to show how many subjects remain under observation at each interval.


```{r stat_2_surv_response_overall}
res_surv_response_02$surv[[1]]$`KM overall`
```


##### Kaplan-Meier Stratified  {.tabset .unnumbered}  

When you divide the cohort into subgroups (e.g., treatment vs. control, biomarker high vs. low), you generate separate curves to compare survival patterns:  
- **Overlaid curves:** Different line styles or colors distinguish each subgroup.  
- **Dashed line at 50% survival:** Marks the median survival time across curves for visual comparison.  
- **Log-rank test p-value:** Assesses whether observed differences between curves are statistically significant.  
- **Hazard ratio (optional):** From a Cox model, quantifies the relative risk between strata.  
- **Group-specific medians and landmark rates:** Reported side-by-side to highlight subgroup differences.  

###### PS-ECOG {.unnumbered}  
```{r stat_2_surv_response_stratified_ecog}
res_surv_response_02$surv[[1]]$`KM stratified`
```

###### First Systemic Therapy {.unnumbered}  
```{r stat_2_surv_response_stratified_firstSYSther}
res_surv_response_02$surv[[2]]$`KM stratified`
```

###### AE Grade 3-4 {.unnumbered}  
```{r stat_2_surv_response_stratified_aeGRADE34}
res_surv_response_02$surv[[3]]$`KM stratified`
```

###### Monotherapy {.unnumbered}  
```{r stat_2_surv_response_stratified_monotherapy}
res_surv_response_02$surv[[4]]$`KM stratified`
```

###### Gender {.unnumbered}  
```{r stat_2_surv_response_stratified_sex}
res_surv_response_02$surv[[5]]$`KM stratified`
```


##### Cox Proportional Hazards {.tabset .unnumbered}  

***Cox PH Table Output***

A standard Cox PH results table typically includes:  
- **Hazard Ratio (HR):** The estimated relative risk per unit change (or category) in each covariate.  
- **95% Confidence Interval (CI):** Lower and upper bounds for the HR, indicating precision.  
- **p-value:** Significance of the association between each covariate and the hazard.  

***Cox PH Plot***

To visualize model-based survival differences you can use:  
- **Dichotomous variable plot:** Two survival curves (e.g., exposed vs. unexposed), annotated with HR and p-value from the Cox model.  

**Forest Plot Analysis**  

This forest plot displays the effect estimates from a Cox proportional hazards model:  

- **Point estimates and confidence intervals (CIs):** Each covariate is represented by a square indicating the hazard ratio (HR), with horizontal lines showing the 95% confidence interval.   
- **Reference categories:** For categorical variables (e.g., `stage_early`), one level is set as the reference.  
- **Continuous variable (`var_indep`):** Modeled directly without categorization, showing the HR per unit increase.  
- **Global model metrics:** The bottom of the plot displays the number of events, global p-value from the log-rank test, AIC, and concordance index, reflecting model fit and discrimination.  

This approach allows for a more precise estimation of the continuous variable’s effect without loss of information due to categorization.  



###### PS-ECOG {.unnumbered}  
```{r stat_2_surv_response_cox_table_ecog}
res_surv_response_02$surv[[1]]$`CoxPH print table`
```

```{r stat_2_surv_response_cox_plot_ecog}
res_surv_response_02$surv[[1]]$`CoxPH plot`
```


###### First Systemic Therapy {.unnumbered}  
```{r stat_2_surv_response_cox_table_firstTH}
res_surv_response_02$surv[[2]]$`CoxPH print table`
```

```{r stat_2_surv_response_cox_plot_firstTH}
res_surv_response_02$surv[[2]]$`CoxPH plot`
```


###### AE Grade 3-4 {.unnumbered}  
```{r stat_2_surv_response_cox_table_aeGrade}
res_surv_response_02$surv[[3]]$`CoxPH print table`
```

```{r stat_2_surv_response_cox_plot_aeGrade}
res_surv_response_02$surv[[3]]$`CoxPH plot`
```


###### Monotherapy {.unnumbered}  
```{r stat_2_surv_response_cox_table_monotherapy}
res_surv_response_02$surv[[4]]$`CoxPH print table`
```

```{r stat_2_surv_response_cox_plot_monotherapy}
res_surv_response_02$surv[[4]]$`CoxPH plot`
```


###### Gender {.unnumbered}  
```{r stat_2_surv_response_cox_table_gender}
res_surv_response_02$surv[[5]]$`CoxPH print table`
```

```{r stat_2_surv_response_cox_plot_gender}
res_surv_response_02$surv[[5]]$`CoxPH plot`
```


###### BMI {.unnumbered}  
```{r stat_2_surv_response_cox_table_bmi}
res_surv_response_02$surv[[6]]$`CoxPH print table`
```

```{r stat_2_surv_response_cox_plot_bmi}
res_surv_response_02$surv[[6]]$`CoxPH plot full`
```

```{r stat_2_surv_response_cox_forest_bmi}
res_surv_response_02$surv[[6]]$`CoxPH forest plot full`
```


###### Age {.unnumbered}  
```{r stat_2_surv_response_cox_table_age}
res_surv_response_02$surv[[7]]$`CoxPH print table`
```

```{r stat_2_surv_response_cox_plot_age}
res_surv_response_02$surv[[7]]$`CoxPH plot full`
```

```{r stat_2_surv_response_cox_forest_age}
res_surv_response_02$surv[[7]]$`CoxPH forest plot full`
```



### Linear regression  
#### Time to response  

Linear regression was identified as the most suitable model for the non-zero subset of the *Time to response* variable, based on residual analysis. The table below shows that none of the tested independent variables had a statistically significant association with $response\_time\_to$.

<u>**The model equation:**</u>
$$
\begin{aligned}
\operatorname{Time to response} &= \alpha + \beta_{1}(\operatorname{independent variable}) + \beta_{2}(\operatorname{Stage Early}) + \epsilon\\
\varepsilon_i &\sim \mathcal{N}(0,\,\sigma^2)
\end{aligned}
$$


```{r}
res_timeTOeffect_02 <- d04 |> 
  select(response_time_to, stage_early, all_of(variab_indep_02)) |> 
  filter(response_time_to > 0) |> 
  mutate(sex = if_else(sex == "M",1,0)) |> 
  pivot_longer(cols = -c("response_time_to", "stage_early"),
               names_to = "indep_name",
               values_to = "indep_value") |> 
  group_by(indep_name) |> 
  nest() |> 
  mutate(mod = map(data, ~lm(data = .x, response_time_to ~ indep_value + stage_early)),
         tidier = map(mod, ~tidy(.x, conf.int = T)),
         qqplot = map2(mod, indep_name, ~ggqqplot(na.omit(resid(.x)) |> as_tibble(),
                                                  x = "value", title = .y)
                       )) 


res_timeTOeffect_02_tab <- res_timeTOeffect_02|> 
  unnest(tidier) |> 
  filter(!str_detect(term, "(Intercept)")) |> 
  select(-(data:mod), -qqplot)


res_timeTOeffect_02_tab |> 
  select(-std.error, - statistic) |> 
  kable(col.names = c("Independent", "Term", "Estimate", "p-value",
                      "5% CI", "95% CI"),
        digits = 3) |> 
  kable_styling(
    full_width = F,
    latex_options = c(
      "hold_position" # stop table floating
    ),
    bootstrap_options = c("striped", "hover", "condensed", "responsive")
  ) %>%
  collapse_rows(columns = 1, valign = "top") |> 
  footnote(general_title = "Note.", 
           footnote_as_chunk = TRUE,
           threeparttable = TRUE,
           general = "Data without zero values.")

```


# Conclussion  

This analysis explored both the tolerability and efficacy of bexarotene in patients with T-lymphoma. The results indicate that monotherapy was associated with a higher likelihood of treatment discontinuation due to adverse events, and that BMI significantly influenced the risk of developing severe hypertriglyceridemia. These findings suggest that both treatment strategy and metabolic profile play important roles in managing toxicity.  

Regarding efficacy, early-stage patients were more likely to receive first-line systemic therapy or monotherapy, both of which were associated with treatment response. However, no variable significantly predicted the time to response in linear modeling.

Survival analyses illustrated differences in treatment duration and time to next therapy across several clinical subgroups, though statistical significance was not consistent. Overall, the findings emphasize the importance of personalized risk assessment when initiating bexarotene therapy, particularly in relation to BMI and therapeutic approach.  

# Session info

<details>

<summary>Platform</summary>

```{r session_info_1}
df_session_platform <- devtools::session_info()$platform %>% 
  unlist(.) %>% 
  as.data.frame(.) %>% 
  rownames_to_column(.)

colnames(df_session_platform) <- c("Setting", "Value")

kable(
  df_session_platform, 
  booktabs = T, 
  align = "l",
  caption = "(ref:Reproducibility-SessionInfo-R-environment-title)", # complete caption for main document
  caption.short = " " # "(ref:Reproducibility-SessionInfo-R-environment-caption)" # short caption for LoT
) %>% 
  kable_styling(full_width = F,
                latex_options = c(
                  "hold_position" # stop table floating
                ),
                bootstrap_options = c("striped", "hover", "condensed", "responsive")
  ) 

```

</details>

<details>

<summary>Used packages</summary>

```{r session_info_2, results = 'asis'}
subset(data.frame(sessioninfo::package_info()), attached==TRUE, c(package, loadedversion, date))
```

</details>

<br> <br> <br> <br> <br> <br>

::: {.tocify-extend-page data-unique="tocify-extend-page" style="height: 0;"}
:::

